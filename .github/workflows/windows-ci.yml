name: windows-ci

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest
    env:
      GRB_WLSACCESSID: ${{ secrets.GRB_WLSACCESSID }}
      GRB_WLSSECRET: ${{ secrets.GRB_WLSSECRET }}
      GRB_LICENSEID: ${{ secrets.GRB_LICENSEID }}
      GUROBI_MSI_URL: ${{ secrets.GUROBI_MSI_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ninja
        run: choco install -y ninja

      - name: Install zlib (vcpkg)
        shell: pwsh
        run: |
          $vcpkgRoot = "C:\vcpkg"
          if (-not (Test-Path $vcpkgRoot)) {
            git clone https://github.com/microsoft/vcpkg $vcpkgRoot
          }
          & "$vcpkgRoot\bootstrap-vcpkg.bat"
          & "$vcpkgRoot\vcpkg.exe" install zlib:x64-windows
          "CMAKE_TOOLCHAIN_FILE=$vcpkgRoot\scripts\buildsystems\vcpkg.cmake" | Out-File -FilePath $env:GITHUB_ENV -Encoding ascii -Append

      - name: Download and extract Gurobi (MSI)
        shell: pwsh
        run: |
          if (-not $env:GUROBI_MSI_URL) { throw "Missing GUROBI_MSI_URL secret." }
          Invoke-WebRequest -Uri $env:GUROBI_MSI_URL -OutFile gurobi.msi
          $msiSize = (Get-Item gurobi.msi).Length
          if ($msiSize -lt 1000000) { throw "Downloaded MSI seems too small ($msiSize bytes). Check GUROBI_MSI_URL." }
          Write-Host "Downloaded MSI size: $msiSize bytes"

          $extractRoot = "C:\gurobi_extract"
          if (Test-Path $extractRoot) { Remove-Item -Recurse -Force $extractRoot }
          $logPath = Join-Path $env:RUNNER_TEMP "msiexec.log"
          $proc = Start-Process msiexec -ArgumentList "/a gurobi.msi /qn TARGETDIR=$extractRoot /l*v `"$logPath`"" -Wait -PassThru
          if ($proc.ExitCode -ne 0) {
            if (Test-Path $logPath) { Get-Content $logPath -Tail 200 } else { Write-Host "msiexec.log not found at $logPath" }
            throw "MSI extraction failed with exit code $($proc.ExitCode)"
          }

          $gurobiWin64 = Get-ChildItem -Path $extractRoot -Recurse -Directory -Filter "win64" |
            Where-Object { Test-Path (Join-Path $_.FullName "include\gurobi_c.h") } |
            Select-Object -First 1
          if (-not $gurobiWin64) {
            Get-ChildItem -Path $extractRoot -Depth 2 | Out-String | Write-Host
            throw "Gurobi win64 folder not found under $extractRoot"
          }

          "GUROBI_ROOT=$($gurobiWin64.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding ascii -Append

      - name: Write WLS license file
        shell: pwsh
        run: |
          if (-not $env:GRB_WLSACCESSID -or -not $env:GRB_WLSSECRET -or -not $env:GRB_LICENSEID) {
            throw "Missing WLS secrets."
          }
          @(
            "WLSACCESSID=$env:GRB_WLSACCESSID"
            "WLSSECRET=$env:GRB_WLSSECRET"
            "LICENSEID=$env:GRB_LICENSEID"
          ) | Out-File -Encoding ascii $env:GITHUB_WORKSPACE\gurobi.lic

          "GRB_LICENSE_FILE=$env:GITHUB_WORKSPACE\gurobi.lic" | Out-File -FilePath $env:GITHUB_ENV -Encoding ascii -Append

      - name: Build RouteOpt dependencies
        shell: pwsh
        run: |
          $env:GUROBI_ROOT | python build.py

      - name: Build CVRP
        shell: pwsh
        run: |
          cmake -S packages\application\cvrp -B packages\application\cvrp\build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$env:CMAKE_TOOLCHAIN_FILE"
          cmake --build packages\application\cvrp\build

      - name: Run CVRP smoke test
        shell: pwsh
        run: |
          if (-not $env:GUROBI_ROOT) { throw "GUROBI_ROOT is not set." }
          $xgbDllDir = Join-Path $env:GITHUB_WORKSPACE "packages\external\xgb\lib"
          $gurobiBin = Join-Path $env:GUROBI_ROOT "bin"
          $env:PATH = "$gurobiBin;$xgbDllDir;$env:PATH"
          .\packages\application\cvrp\bin\cvrp.exe packages\application\cvrp\instance\P-n20-k2.vrp -u 217
